
/*! TVBot - v0.1.0 - 2014-11-04
* http://...github url.../
* Copyright (c) 2014 flibbr; Licensed MIT */

function TVBot(){this.init()}var events=require("events"),request=require("request"),curl=require("node-curl"),fs=require("fs"),mysql=require("mysql"),ee=new events.EventEmitter,WebSocketClient=require("websocket").client,unixTime=require("unix-time"),timeago=require("timeago"),db=mysql.createConnection({host:"localhost",user:"TVChatBot",password:"TVChatBot",database:"TVChatBot"});db.connect();var tvURL="https://www.tradingview.com";TVBot.prototype.setOwners=function(a){that=this,that.owners=a},TVBot.prototype.seen=function(a){that=this;var b={Username:db.escape(a)},c=db.query("SELECT * from ChatLog WHERE ? ORDER BY Timestamp DESC LIMIT 1",b,function(a,b){if(a)throw a;if(b.length>0){var c="last seen "+b[0].Username+" "+timeago(new Date(1e3*b[0].Timestamp))+", '"+b[0].Text+"'";that.sendMessage(c)}});console.log(c.sql)},TVBot.prototype.busy=function(a){that=this;var b=that.periods;if(b[a]){var c=unixTime(new Date)-b[a];db.query("SELECT Username, Count(*) as TotalPosts FROM ChatLog WHERE Timestamp > ? AND Username != ? GROUP BY Username ORDER BY TotalPosts DESC LIMIT 3",[c,db.escape(that.username)],function(b,c){if(b)throw b;var d="Busy chatters in the last "+a+"\n",e=c.length;for(var f in c)d+=c[f].Username+": "+c[f].TotalPosts,f!=e-1&&(d+="\n");that.sendMessage(d)})}},TVBot.prototype.sentiment=function(a){that=this;var b=that.periods;if(b[a]){var c=unixTime(new Date)-b[a];sums={bulls:1,bears:1,total:2};{db.query("SELECT COUNT(*) as Total FROM (select COUNT(*) FROM ChatLog WHERE Timestamp > ? AND Text REGEXP '^(up|bull|buy|moon|uptrend|bull flag|pump|short squeeze)' GROUP BY Username) bulls",[c],function(b,d){if(b)throw b;sums.bulls=sums.bulls+d[0].Total;db.query("SELECT COUNT(*) as Total FROM (select COUNT(*) FROM ChatLog WHERE Timestamp > ? AND Text REGEXP '^(down|bear|sell|bear flag|double top|dumping|dump|long squeeze|downtrend)' GROUP BY Username) bulls",[c],function(b,c){if(b)throw b;sums.bears=sums.bears+c[0].Total,sums.total=sums.bulls+sums.bears,console.log(sums),msg=a+" sentiment index: Bulls: "+Math.round(sums.bulls/sums.total*100)+"%, Bears: "+Math.round(sums.bears/sums.total*100)+"%",that.sendMessage(msg)})})}}},TVBot.prototype.slap=function(a,b){that=this,msg=a+" slaps "+b+" around a bit with a large trout",that.sendMessage(msg)},TVBot.prototype.quote=function(a){that=this;db.query("SELECT Username, Text from ChatLog WHERE CHAR_LENGTH(Text) >= 3 AND CHAR_LENGTH(Text) <= 200 AND Username=? LIMIT 1",[db.escape(a)],function(a,b){if(a)throw a;if(b.length>0){var c=b[0].Username+': "'+b[0].Text;that.sendMessage(c)}})},TVBot.prototype.login=function(a,b){that=this,that.username=a,(login_curl=curl.create())(tvURL+"/accounts/signin/",{POST:1,POSTFIELDS:"username="+a+"&password="+b},function(){var a={};this.header.split(" ").forEach(function(b){qparts=b.split("&");for(i in qparts)qpart=qparts[i].split("="),a[decodeURIComponent(qpart[0])]=decodeURIComponent(qpart[1]||"")}),that.csrftoken=a.csrftoken.substring(0,a.csrftoken.length-1),that.sessionid=a.sessionid.substring(0,a.sessionid.length-1),console.log("logged in.... "),that.watchChat(),this.close()})},TVBot.prototype.sendMessage=function(a){that=this,(sendmsg_curl=curl.create())(tvURL+"/conversation-post/",{POST:1,POSTFIELDS:"text="+encodeURIComponent(a)+"&room=bitcoin&symbol=FROM:Botland&meta={}",COOKIE:"csrftoken="+that.csrftoken+";sessionid="+that.sessionid},function(){this.close()})},TVBot.prototype.watchChat=function(){that=this;var a=new WebSocketClient;a.on("connectFailed",function(a){console.log("Connect Error: "+a.toString())}),a.on("connect",function(a){console.log("WebSocket client connected"),a.on("error",function(a){console.log("Connection Error: "+a.toString())}),a.on("close",function(){console.log("echo-protocol Connection Closed")}),a.on("message",function(a){if("utf8"===a.type){msg=JSON.parse(a.utf8Data);try{if("bitcoin"==msg.text.content.data.room){var b=msg.text.content.data,c={Username:b.username,Text:b.text,Room:b.room,PublishTime:b.time,Timestamp:unixTime(new Date)},d=(db.query("INSERT INTO ChatLog SET ?",c,function(){console.log("Inseted post by "+b.username+": "+b.text)}),b.text.substring(0,1));if(words=[],"!"==d&&that.owners.indexOf(b.username)>-1)switch(b.text.split(/\s+/).forEach(function(a){a=a.toLowerCase().replace(/\W+/g,""),words.push(a)}),words[0]){case"seen":that.seen(words[1]);break;case"stats":console.log("stats.");break;case"busy":that.busy(words[1]);break;case"sentiment":that.sentiment(words[1]);break;case"slap":that.slap(b.username,words[1]);break;case"quote":that.quote(words[1])}}}catch(e){}}})}),a.connect("ws://tradingview.com/message-pipe-ws/public/")},TVBot.prototype.init=function(){this.periods={"24h":86400,"12h":43200,"1h":3600,"30m":1800,"5m":300}};