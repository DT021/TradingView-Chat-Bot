
/*! TVBot - v0.1.0 - 2014-11-03
* http://...github url.../
* Copyright (c) 2014 flibbr; Licensed MIT */

function TVBot(){}var events=require("events"),request=require("request"),curl=require("node-curl"),fs=require("fs"),mysql=require("mysql"),ee=new events.EventEmitter,WebSocketClient=require("websocket").client,unixTime=require("unix-time"),timeago=require("timeago"),db=mysql.createConnection({host:"localhost",user:"TVChatBot",password:"TVChatBot",database:"TVChatBot"});db.connect();var tvURL="https://www.tradingview.com";TVBot.prototype.seen=function(a){that=this;{var b={Username:a};db.query("SELECT * from ChatLog WHERE ? ORDER BY Timestamp DESC LIMIT 1",b,function(a,b){if(console.log(b),b[0].Id){var c="last seen "+b[0].Username+" "+timeago(new Date(1e3*b[0].Timestamp))+", '"+b[0].Text+"'";console.log(c),that.sendMessage(c),that.sendMessage("last seen zoinky 22 minutes ago, 'bitcoin's network is just too large, its counterproductive'")}})}},TVBot.prototype.login=function(a,b){that=this,curl(tvURL+"/accounts/signin/",{POST:1,POSTFIELDS:"username="+a+"&password="+b},function(){var a={};this.header.split(" ").forEach(function(b){qparts=b.split("&");for(i in qparts)qpart=qparts[i].split("="),a[decodeURIComponent(qpart[0])]=decodeURIComponent(qpart[1]||"")}),that.csrftoken=a.csrftoken.substring(0,a.csrftoken.length-1),that.sessionid=a.sessionid.substring(0,a.sessionid.length-1),console.log("got connected.... "),that.watchChat()})},TVBot.prototype.sendMessage=function(a){that=this,curl(tvURL+"/conversation-post/",{POST:1,POSTFIELDS:"text="+encodeURIComponent(a)+"&room=bitcoin&symbol=FROM:Botland&meta={}",COOKIE:"csrftoken="+that.csrftoken+";sessionid="+that.sessionid},function(a){console.log(a),console.log(this.body)})},TVBot.prototype.watchChat=function(){that=this;var a=new WebSocketClient;a.on("connectFailed",function(a){console.log("Connect Error: "+a.toString())}),a.on("connect",function(a){console.log("WebSocket client connected"),a.on("error",function(a){console.log("Connection Error: "+a.toString())}),a.on("close",function(){console.log("echo-protocol Connection Closed")}),a.on("message",function(a){if("utf8"===a.type){msg=JSON.parse(a.utf8Data);try{if("bitcoin"==msg.text.content.data.room){var b=msg.text.content.data,c={Username:b.username,Text:b.text,Room:b.room,PublishTime:b.time,Timestamp:unixTime(new Date)},d=(db.query("INSERT INTO ChatLog SET ?",c,function(){console.log("Inseted post by "+b.username+": "+b.text)}),b.text.substring(0,1));if(words=[],"!"==d&&("flibbr"==b.username||"zoinky"==b.username))switch(b.text.split(/\s+/).forEach(function(a){a=a.toLowerCase().replace(/\W+/g,""),words.push(a)}),console.log(words),words[0]){case"seen":that.seen(words[1]);break;case"stats":console.log("stats.")}}}catch(e){console.log(msg)}}})}),a.connect("ws://tradingview.com/message-pipe-ws/public/")};